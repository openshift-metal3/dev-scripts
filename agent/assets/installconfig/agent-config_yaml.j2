{% set ips = agent_nodes_ips.split(',') %}
{% set ipsv6 = agent_nodes_ipsv6.split(',') %}
{% set macs = agent_nodes_macs.split(',') %}
{% set hostnames = agent_nodes_hostnames.split(',') %}
apiVersion: v1alpha1
metadata:
  name: {{ cluster_name }} 
  namespace: {{ cluster_namespace }}
rendezvousIP: {{ ips[0] }} 
{% if networking_mode != "dhcp" %}
hosts:
{% for hostname in hostnames %}
    - hostname: {{ hostname }}
      interfaces:
        - name: eth0 
          macAddress: {{ macs[loop.index0] }} 
      networkConfig:
        interfaces:
          - name: eth0
            type: ethernet
            state: up
            mac-address: {{ macs[loop.index0] }} 
{% if ip_stack == "v4" %}
            ipv4:
              enabled: true
              address:
                - ip: {{ ips[loop.index0] }} 
                  prefix-length: {{ cluster_host_prefix_v4 }}
              dhcp: false
        dns-resolver:
          config:
            server:
              - {{ provisioning_host_external_ip }} 
        routes:
          config:
            - destination: 0.0.0.0/0
              next-hop-address: {{ provisioning_host_external_ip }} 
              next-hop-interface: eth0
              table-id: 254
{% elif ip_stack == "v6" %}
            ipv6:
              enabled: true
              address:
                - ip: {{ ipsv6[loop.index0] }} 
                  prefix-length: {{ cluster_host_prefix_v6 }} 
              dhcp: false
        dns-resolver:
          config:
            server:
              - {{ provisioning_host_external_ip }} 
        routes:
          config:
            - destination: ::/0 
              next-hop-address: {{ provisioning_host_external_ip }} 
              next-hop-interface: eth0
              table-id: 254
{% else %}
            ipv4:
              enabled: true
              address:
                - ip: {{ ips[loop.index0] }} 
                  prefix-length: {{ cluster_host_prefix_v4 }} 
              dhcp: false
            ipv6:
              enabled: true
              address:
                - ip: {{ ipsv6[loop.index0] }} 
                  prefix-length: {{ cluster_host_prefix_v6 }} 
              dhcp: false
        dns-resolver:
          config:
            server:
              - {{ provisioning_host_external_ip }} 
              - {{ provisioning_host_external_ip_dualstack }}
        routes:
          config:
            - destination: 0.0.0.0/0
              next-hop-address: {{ provisioning_host_external_ip }} 
              next-hop-interface: eth0
              table-id: 254
            - destination: ::/0
              next-hop-address: {{ provisioning_host_external_ip_dualstack }}
              next-hop-interface: eth0
              table-id: 254
{% endif %}
{% endfor %}
{% endif %}
